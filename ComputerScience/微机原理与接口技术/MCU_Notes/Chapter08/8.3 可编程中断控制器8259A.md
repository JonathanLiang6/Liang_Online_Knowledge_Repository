### 8.3.1 8259A的内部结构和引脚
#### 8.3.1.1 内部结构
![[../../MCU_Picture/Pasted image 20250526214803.png]]
**数据总线缓冲器**：
8位双向三态缓冲器，连接系统数据总线（通常为低8位 $D_7 \sim D_0$），/用于CPU写入控制字、读取状态信息及传送中断类型号。
**读/写控制逻辑**：
接收CPU的读/写命令，配合片选信号（CS）和地址输入（A₀）完成操作，传输命令字至寄存器或输出寄存器内容至数据总线。
**级联缓冲/比较器**：
用于多片8259A级联，存放和比较从片的3位识别码，支持最多9片级联管理64个中断源。
**中断请求寄存器（IRR）**：
8位锁存寄存器，存放外部中断请求信号（IR₇~IR₀），对应位为1表示有中断请求，响应后相应位复位。
**中断屏蔽寄存器（IMR）**：
8位寄存器，每位对应一个中断请求输入（IRᵢ），置1屏蔽对应中断，置0允许中断。
**中断服务寄存器（ISR）**：
8位寄存器，保存正在处理的中断请求，响应中断时对应位置1，处理结束后清零，支持中断嵌套时多位置1。
**优先权分析器（PR）**：
判别IRR中中断请求的优先级，将最高优先级请求送CPU；中断嵌套时比较新请求与ISR中当前请求的优先级，决定是否触发中断。
**控制逻辑**：
根据IRR和IMR状态，通过PR判定优先级，向CPU发送INT信号并接收响应信号，控制ISR和IRR的置位/复位，处理中断类型号的传送。
#### 8.3.1.2 引脚信号
- **数据总线（D₇~D₀）**
双向三态，用于与CPU的数据交换
较小系统中**直接**连接系统数据总线
大系统中需经**总线驱动器**连接系统总线
- **中断请求输入（IR₀~IR₇）**
8条外设中断请求线，由外设传给 8259A
IR₀优先级最高，IR₇最低；
主从式的级联中断系统中，主片IRᵢ 连接从片INT端
接收来自各从片的中断请求 INT，由从片的中断请求输入端 IR0～IR7 和主片未连接从片的中断请求输入端接受中断源的中断请求。
![[../../MCU_Picture/Pasted image 20250528083504.png]]
- **中断请求输出（INT）**：主片连接CPU的INTR引脚，从片连接主片的IRᵢ引脚，用于发送中断请求。
- **中断响应输入（$\overline{INTA}$）**：接收CPU的中断响应信号，用于中断响应周期。
- **读/写控制（$\overline{RD}$，$\overline{WR}$）**：输入信号，有效时分别控制8259A向CPU输出数据（读）或从数据总线接收数据（写）。
- **片选信号（$\overline{CS}$）**：输入信号，有效时选中8259A。
- **端口选择（A₀）**：输入信号，连接地址总线A₀，0选中偶地址端口，1选中奇地址端口。
- **级联信号（CAS₂~CAS₀）**：主片输出从片输入，主片通过组合信号（000~111）选择从片，从片通过信号识别是否被选中。
- **主从/缓冲允许（$\overline{SP}/\overline{EN}$）**：输入/输出信号，非缓冲方式时，1为主片，0为从片；缓冲方式时输出控制信号，启动总线驱动器。
### 8.3.2 8259A的工作方式
#### 8.3.2.1 中断触发方式：决定外设以何种信号通知 8259A 有中断请求。
- **边沿触发**：IRᵢ输入端的上升沿触发中断请求
**优点**：允许IRᵢ保持高电平而不重复触发。
- **电平触发**：IRᵢ输入端的高电平触发中断请求
注意：响应后需及时撤除高电平，避免二次触发。
#### 8.3.2.2 中断优先级设置方式
- **完全嵌套方式**：初始化默认方式，IR₀优先级最高，IR₇最低，高优先级可中断低优先级服务，支持中断嵌套。
- **自动循环方式**：响应中断后，该中断优先级变为最低，下一级变为最高，优先级循环（如IR₄服务后，IR₅最高，IR₄最低）。
- **特殊完全嵌套方式**：允许同级中断请求响应，主片工作于此方式，从片工作于完全嵌套方式，用于级联系统的同级中断嵌套。
- **特殊循环方式**：通过编程指定初始最低优先级，优先级按循环方式重新排列，由OCW2控制。

#### 8.3.2.3 中断屏蔽方式
- **普通屏蔽方式**：通过IMR寄存器置1屏蔽对应IRᵢ中断，置0允许中断，直接控制中断请求的传递。
- **特殊屏蔽方式**：置1 IMR对应位并清0 ISR对应位，使系统看似未处理任何中断，允许响应低优先级中断，适用于非正常优先级管理。

#### 8.3.2.4 中断结束方式
- **自动结束方式（AEOI）**：硬件自动在中断响应的第二个INTA脉冲后沿清0 ISR对应位，仅适用于单片无嵌套场景。
- **命令结束方式（EOI）**：
  - **一般EOI**：清除ISR中当前最高优先级位，用于全嵌套方式，通过OCW2发送命令。
  - **特殊EOI**：明确指定清除ISR中的某一位，适用于嵌套结构可能破坏的场景，通过OCW2发送带L₂~L₀编码的命令。

#### 8.3.2.5 连接系统总线方式
- **非缓冲方式**：适用于中小系统，8259A直接连接数据总线，SP/EN作为输入（单片接+5V，多片主片接+5V、从片接地）。
- **缓冲方式**：适用于大系统，8259A通过总线驱动器连接数据总线，SP/EN输出低电平控制驱动器启动。

### 8.3.3 8259A的级联
- **级联目的**：当外部中断源超过8个时，通过多片级联扩展中断管理能力，最多9片级联管理64个中断源。
- **级联方式**：主片的IR₀~IR₇连接从片的INT端，主片通过CAS₂~CAS₀选择从片，从片通过识别CAS信号确定是否被选中。
- **优先级管理**：级联系统中，主片IR₀~IR₇优先级高于从片，从片内部优先级由其自身设置（如完全嵌套）。

### 8.3.4 8259A的命令字
#### 8.3.4.1 初始化命令字（ICW1~ICW4）
- **ICW1（芯片控制初始化命令字）**：
  - **格式**：A₀=0，D₄=1（特征位），D₃（LTIM）设置触发方式（1=电平，0=边沿），D₁（SNGL）设置单片/级联（1=单片，0=级联），D₀（ICW₄）设置是否需要ICW4（8086系统必须为1）。
  - **写入地址**：偶地址（A₀=0）。
- **ICW2（中断类型号基值设置）**：
  - **格式**：A₀=1，D₇~D₃为中断类型号高5位，IR₀~IR₇的类型号低3位为其序号（0~7）。
  - **写入地址**：奇地址（A₀=1）。
- **ICW3（级联设置命令字）**：
  - **主片**：A₀=1，D₇~D₀对应IR₇~IR₀，接从片的位设为1，否则为0。
  - **从片**：A₀=1，D₂~D₀为从片标志码（ID₂~ID₀），对应连接的主片IRᵢ序号。
  - **写入条件**：仅级联时需要，主片和从片分别写入。
- **ICW4（工作方式设置命令字）**：
  - **格式**：A₀=1，D₄（SFNM）设置是否为特殊完全嵌套（1=是），D₃（BUF）设置缓冲方式（1=缓冲），D₂（M/S）在缓冲方式下区分主从（1=主片，0=从片），D₁（AEOI）设置自动结束方式（1=是），D₀（APM）设置是否为8086系统（1=是）。
  - **写入条件**：ICW1的D₀=1时需要。

#### 8.3.4.2 操作命令字（OCW1~OCW3）
- **OCW1（中断屏蔽命令字）**：
  - **格式**：A₀=1，M₇~M₀对应屏蔽IR₇~IR₀（1=屏蔽，0=允许）。
  - **功能**：直接操作IMR寄存器，动态屏蔽中断源。
- **OCW2（优先级循环与中断结束命令字）**：
  - **格式**：A₀=0，D₇（R）控制优先级循环（1=循环，0=固定），D₆（SL）决定D₂~D₀是否有效（1=有效），D₅（EOI）控制中断结束（1=发送EOI命令），D₂~D₀（L₂~L₀）指定优先级或清除的ISR位。
  - **功能**：设置优先级循环方式和中断结束方式，支持一般/特殊EOI和自动/特殊循环。
- **OCW3（特殊屏蔽与查询命令字）**：
  - **格式**：A₀=0，D₆（ESMM）和D₅（SMM）组合设置特殊屏蔽方式（11=设置，10=取消），D₂（P）启动中断查询（1=查询），D₁（RR）和D₀（RIS）控制读取IRR或ISR（RR=1，RIS=1读ISR，0读IRR）。
  - **功能**：管理特殊屏蔽方式，查询中断状态，读取IRR/ISR内容。

### 8.3.5 8259A内部寄存器访问方式
- **寄存器列表**：包括IRR、IMR、ISR、ICW1~ICW4、OCW1~OCW3和状态寄存器，共11个寄存器。
- **地址映射**：通过A₀区分两个端口（A₀=0为偶地址，A₀=1为奇地址）：
  - **偶地址（A₀=0）**：写入ICW1、OCW2、OCW3；读取IRR、ISR、中断查询字。
  - **奇地址（A₀=1）**：写入ICW2、ICW3、ICW4、OCW1；读取IMR。
- **读/写操作表**：

| 操作类型                   | A₀  | D₄/D₃ | 寄存器/命令字       | 指令  |
| ---------------------- | --- | ----- | ------------- | --- |
| 写入 ICW1                | 0   | 1X    | ICW1          | OUT |
| 写入 ICW2/ICW3/ICW4/OCW1 | 1   | XX    | 对应命令字         | OUT |
| 写入 OCW2                | 0   | 00    | OCW2          | OUT |
| 写入 OCW3                | 0   | 01    | OCW3          | OUT |
| 读取 IRR/ISR/查询字         | 0   | XX    | IRR/ISR/中断查询字 | IN  |
| 读取 IMR                 | 1   | XX    | IMR           | IN  |



### 8.3.6 8259A在IBM PC/AT系统中的应用
- **硬件连接**：主片端口地址20H/21H，从片0A0H/0A1H，从片INT连接主片IR₂，支持15级中断。
- **初始化配置**：
  - **主片**：边沿触发，级联模式，中断类型号基址08H，完全嵌套，非缓冲，普通EOI。
  - **从片**：边沿触发，级联模式，中断类型号基址70H，连接主片IR₂，完全嵌套，非缓冲，普通EOI。
- **初始化代码示例**：
```assembly
  ; 主片初始化
  MOV AL, 00010001B ; ICW1：边沿触发，级联，需要ICW4
  OUT 20H, AL
  MOV AL, 00001000B ; ICW2：基址08H
  OUT 21H, AL
  MOV AL, 00000100B ; ICW3：IR₂接从片（主片IR₂位设为1）
  OUT 21H, AL
  MOV AL, 00000001B ; ICW4：8086模式，完全嵌套，非缓冲，普通EOI
  OUT 21H, AL

  ; 从片初始化
  MOV AL, 00010001B ; ICW1：边沿触发，级联，需要ICW4
  OUT 0A0H, AL
  MOV AL, 01110000B ; ICW2：基址70H
  OUT 0A1H, AL
  MOV AL, 00000010B ; ICW3：从片标志码010（对应主片IR₂）
  OUT 0A1H, AL
  MOV AL, 00000001B ; ICW4：8086模式，完全嵌套，非缓冲，普通EOI
  OUT 0A1H, AL
```
- **编程要点**：主程序完成初始化和中断向量设置，中断服务程序通过 EOI 命令结束中断，使用 DOS 功能调用（如 25H/35H）管理中断向量表。
### [[../../MCU_Contents/第8章 中断技术|回到目录]]