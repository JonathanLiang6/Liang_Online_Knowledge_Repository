### 6.1.1 输入输出系统及其作用
#### 6.1.1.1 输入输出系统简介
**输入输出系统：** 计算机系统中分布在主机周围的各种 I/O 设备及其相关电路和控制软件构成了计算机系统的 I/O 系统，其作用就是实现数据的输入、输出
基本I/O设备：键盘、显示器、鼠标、外存储器、网络接口设备
输入输出典型结构：![[../../Picture/Pasted image 20241128101650.png]]
系统[[6.2 总线|总线]]是系统中需要用到的各种信号线的集合
#### 6.1.1.2 输入输出方式
为满足不同应用的需要，主机和 I/O 设备之间的数据传送方式可以分为：
- 无条件传送，查询方式，中断方式，DMA 方式等
各自有各自的特点、优缺点，使用场景
### 6.1.2 输入输出系统设计的重要原则
- **抽象原则：从多样性中发现共性，建立抽象模型**
I/O设备虽然因为应用领域的不同而具有多样性和复杂性，但是它们和主机之间交换数据时的数据格式、传输方式等却不会太多。  
抽象原则就是要对不同I/O设备的工作机制进行分析，从多样性中发现同一性，找到具有共性的东西，经过概括、总结后，得出系 统设计需要解决的基本问题，建立相应的抽象模型。
- **分治原则：利用I/O接口隔离主机和I/O设备，实现数据交换**
输入输出是主机和I/O设备双方的事。分治原则最重要的含义就是利用I/O接口在一定程度上将双方隔离开来，任意一方直接打交道的对象是接口，接口负责沟通双方。双方协作、互相配合通过I/O 接口实现数据交换，各司其职。 
在设计时，主要解决好：（1）主机一侧和接口之间的数据交换问 题；（2）I/O设备一侧和主机之间的数据交换问题；（3）利用接口 实现双方的同步问题
- **标准原则：设计应遵循可靠性、可用性、可信性标准**
设计输入输出系统应该遵循一定的标准，基本要求是：可靠、可用、可信。 
同时，设计成果也应该进行标准化处理，形成各种标准或规范， 供开发新的I/O设备时遵照执行。
### 数据传送方式：[[#6.1.3 无条件传送方式|无条件]]、[[#6.1.4 查询方式|查询]]、[[#6.1.5 中断方式|中断]]、[[#6.1.6 DMA方式|DMA]] 等 
### 6.1.3 无条件传送方式
• 无条件传送方式是指双方发送/接收数据是无条件的，任何时候想发就发、想收就收。无条件传送方式的数据发送/接收流程如图![[../../Picture/Pasted image 20241128210838.png]]

### 6.1.4 查询方式
#### 6.1.4.1 简介
数据发送/接收是有条件的，需检测是否满足条件，只有满足条件才能发送/接收数据
对主机来说，每次检测发送/接收数据的条件是通过读取接口内部的**状态位**（位于状态端口内）并对其进行分析实现的。
#### 6.1.4.2 同步问题
- 交换数据时的同步工作：**先发后收**规则
为此，发送方在发送数据前需要知道接收方是否已经准备好接收数据，而接收方需要知道是否有数据需要接收。 
确保双方按此规则发送/接收数据的**基本手段**就是设置专门的控制联络信号供双方使用
#### 6.1.4.3 握手与握手协议
双方利用**控制联络信号**实现同步称作**握手**
**控制联络信号**也叫**握手信号**
握手需要遵守的规则称作**握手协议**
控制联络信号实现同步，遵守握手协议规则

#### 6.1.4.4 查询方式缺点：耗费 CPU 时间
主机发送/接收数据之前都要查询条件，如果条件不满足，就得继续查询，
直到条件满足才能发送/接收一个数据。 
为发送/接收下一个数据，还得先查询条件。
这样一来，查询条件会耗费大量的 CPU 时间
### 6.1.5 中断方式
#### 6.1.5.1 中断概念与基本问题
**中断：** 由于系统内外发生的事情，CPU 暂停正在执行的程序转而去处理所发生的事情，处理结束后恢复执行原来暂停的程序
正常执行的程序被发生的事情暂时**中断**
**中断**是 I/O 设备与主机交互的重要方式
**异常：** 异常事件引起的中断

**中断的基本过程：** 中断请求、中断检测、中断响应、中断服务、中断返回 
**中断请求：** 以中断方式和主机交互的 I/O 设备在适当的时候，比如输入设备准备好数据后，会通过中断请求信号线向 CPU 发送中断请求信号，通知 CPU 来取数据。 
**中断检测：** CPU 在正常执行程序的过程中会定期对中断请求信号线进行检测。
**中断响应：** CPU 如果检测到中断请求信号，在系统允许中断的情况下，会通过中断响应信号线向发出中断请求的 I/O 设备发送中断响应信号，通知 I/O 设备其中断请求得到响应，并暂停正在执行的程序，转而进入中断服务程序。 
**中断服务：** 执行中断服务程序，处理所发生的事，比如发送/接收数据。 
**中断返回：** 结束执行中断服务程序，转而回到原来暂停执行的程序
#### 6.1.5.2 中断服务程序与中断源
**中断服务程序：** 事先编写好的一段程序，CPU 通过执行中断服务程序来处理所发生的事，比如发送/接收数据。 
**中断源：** 系统中能够引起中断的各种原因（事件），即中断的来源
**单中断系统：** ![[../../Picture/3881bdfc0783db2dd6224c43a6fa3fe.jpg]]
**多中断系统：**
系统中有多个中断源，即同时有多个中断请求时，优先处理问题解决的办法就是给不同的中断源赋予不同的优先级。当不同优先级的中断源同时产生中断请求时，优先处理级别最高的中断请求。 
中断优先级：通常用无符号数来区分不同的中断源的优先级别。
![[../../Picture/44841ffa56ab19dd846e9e66f11c658.jpg]]
**中断嵌套：**
在处理当前级别最高的中断请求期间，如果来了级别更高的新的中断请求，如果允许中断处理又被中断，正在处理的中断就会被新来的更高级别的中断中断，从而形成嵌套。 **中断嵌套：** 在执行某个中断服务程序的过程中，由于某种原因，需要暂停正在执行的中断服务程序，转而去处理新的中断，等新的中断处理完毕后，又恢复执行被暂停的中断

#### 6.1.5.3 中断管理器
**中断管理器：** 系统中专门负责集中管理各个中断源的部件
**中断请求寄存器**： 用于接收并记录各个中断源的中断请求
**中断屏蔽寄存器：** 用于对各个中断源的中断请求进行屏蔽管理，被屏蔽的中断请求不会被处理
**中断服务寄存器：** 用于记录目前正在处理以及被再次中断而尚未处理完毕的中断请求 
**中断优先级分析电路：** 用于对未被屏蔽的中断请求进行优先级比较分析。
![[../../Picture/Pasted image 20241129161548.png]]
##### 中断管理器和 CPU 协作处理中断的过程：
1. 各个中断源向中断管理器发中断请求
2. 中断管理器记录大家的请求 
3. 如果 CPU 目前没有处理任何中断，中断管理器向 CPU 发中断请求；如果 CPU 目前正在处理某个中断且新来的中断中有比正在处理的中断级别更高的中断，中断管理器也向 CPU 发中断请求 
4. 在允许中断（包括中断正在处理的中断）的情况下，CPU 适时检测中断管理器发送的中断请求 
5. CPU 检测到中断管理器发送的中断请求后，向中断管理器发送响应信号并开始中断响应过程：暂停正在执行的程序或者中断服务程序，保护相关的重要信息。中断管理器和 CPU 协作处理中断的过程 
6. 中断管理器接收到 CPU 发送的中断响应信号后，向 CPU 提供级别最高或者新来的级别最高的中断请求的相关信息 
7. CPU 利用中断管理器提供的级别最高的中断请求的有关信息找到其中断服务程序的起始位置 
8. 开始执行中断服务程序 
9. 在中断服务程序的最后通过执行专门的中断返回指令回到被暂停的程序或中断服务程序
#### 6.1.5.4 查询中断
**中断类型码：** 用来区分不同中断源及其中断服务程序的无符号数。  
**中断向量：** 中断服务程序在内存中的起始位置，也就是入口地址。 
**中断向量表：** 严格按中断类型码由小到大的顺序集中存放所有中断向量的地址表，通常位于内存某固定区域。 
**向量中断：** 中断管理器在收到 CPU 的响应信号后，适时向 CPU提供级别最高或者新来的级别最高的中断请求的中断类型码。CPU在响应期间收到此中断类型码后据此查询中断向量表，找到所需的中断向量，然后利用找到的中断向量转入相应的中断服务程序 ![[../../Picture/Pasted image 20241129164032.png]]
**查询中断：** 这种方式的特点是在 CPU 检测到有中断请求产生时，在中断响应期间通过执行查询程序确定其中级别最高的中断源，并转入响应的中断服务程序查询中断的处理过程如图所示，查询顺序决定了优先级
#### 6.1.5.5 中断方式缺点：仍依赖 CPU
不需要 CPU 查询发送/接收数据的条件，但是最终的数据传送还是要靠 CPU 执行相应的程序（中断服务程序）来完成
### 6.1.6 DMA方式
#### 6.1.6.1 DMA 方式
**DMA 方式：** 在内存和外设之间增设一个专门部件，由它来代替 CPU 负责在内存和外设之间传送数据，这种数据传送方式就是 DMA 方式。 
**DMA 控制器：** 代替 CPU 负责在内存和外设之间传送数据的专门部件。 
计算机系统中的软件（包括程序和数据）平时都存储在外存上。在程序执行过程中，需要用到时再将它们复制到内存。 
指令及数据的**局部性：** 程序在执行过程中，在一段时间内要执行的指令或要访问的数据往往集中在一起。需要用到的程序和数据没必要一次性全部复制到内存，只需要将一段时间需要用到的部分在其第一次需要用到时复制到内存即可。
**局部性带来的好处：** 可以利用有限的内存空间执行大规模程序，处理大规模数据；可以在不同任务间共享内存空间；
#### 6.1.6.2 DMA 的基本过程
DMA 请求：DMA 控制器负责接收外设的 DMA 请求，并及时向 CPU 提出请求。
DMA 检测：CPU 需要定期检测 DMA 控制器发出的请求
DMA 响应：CPU 检测到 DMA 控制器发出的请求后，需要对 DMA 控制器做出应答并让出总线的控制权
DMA 传送：DMA 控制器接管总线控制权，并利用总线传输数据
DMA 结束：数据传输结束后，DMA 控制器归还总线给 CPU，并通知 CPU 数据传送结束。
#### 6.1.6.3 与中断方式的区别
系统处理 DMA 请求的过程与处理中断的过程也基本类似，主要差别体现在：
中断是通过 CPU 执行程序完成数据传输（是一种软件办法），而 DMA 是利用 DMA 控制器完成数据传输（是一种硬件办法）
中断一般允许嵌套，而 DMA 一般不允许嵌套
#### 6.1.6.4 DMA 控制器与 CPU 共享总线的方式
DMA 控制器传输数据时控制**系统总线**，CPU 必须放弃对**系统总线**的控制
不同的计算机系统采用不同方法解决CPU与DMA控制器共享总线的问题，共3种方式：
##### 1. CPU 暂停方式
![[../../Picture/Pasted image 20241130140142.png]]
要求：需要在其接口控制器中设置一定容量的存储器作为**数据缓冲存储器**使用
I/O 设备和主存均只与数据缓冲存储器交换数据
由于数据缓冲存储器的存取速度较快，可以减少由于执行 DMA 数据传送而占用系统总线的时间，从而减少 CPU 暂停时间
**数据缓冲技术:**
不同部件/进程/线程（对于同一进程）之间需要进行交换数据，解决方法就是设立**数据缓冲区：** 作为一个中转站，一方放数据，一方取数据；可以暂时存放数据，可以在一定程度上缓解速度不匹配。容量综合考虑速度差异，数据交换方式，应用场景等灵活确定。
##### 2. 周期挪用方式
![[../../Picture/Pasted image 20241130142343.png]]
I/O 设备有 DMA 传送请求时，DMA 控制器将总线请求发给 CPU 
CPU 无使用总线要求则直接交给 DMA。有要求时空出一个总线周期给 DMA，DMA 传送一个数据字后，再交还给 CPU
I/O 设备的访问优先权高于 CPU 访问。
##### 3. 交替访问方式
![[../../Picture/Pasted image 20241130142333.png]]
前提：CPU 工作速度相对较慢，内存工作速度较快**或**人为拉长 CPU 时间
`e.g 主存存取周期Δt，CPU每2Δt产生一次访存请求，则2Δt内Δt供CPU，Δt供DMA`
#### 6.1.6.5 DMA 控制器
DMA 控制器基本结构：![[../../Picture/Pasted image 20241130145817.png]]
##### **寄存器组：**
用于提供 DMA 过程中需要用到的各种参数，其中：
**主存地址寄存器**为访问内存提供地址，每访问一个单位的数据会自动修改；
**设备地址寄存器**为访问外围设备提供地址；
**传输量计数器**用于控制需要传输的数据总量，传输一个单位的数据会自动修改，通常采用倒计数方式；
**数据缓冲寄存器**在需要时用来暂时存放数据。
##### 控制逻辑对比：
DMA **控制逻辑**：完成 DMA 的预处理（初始化各类寄存器）、接收设备控制器送来的 DMA 请求信号、向设备控制器回答 DMA 允许 （应答）信号、向系统申请总线以及控制总线实现 DMA 传输控制等工作
**中断控制逻辑**：在 DMA 操作完成后向 CPU 发出中断请求，申请 CPU 对 DMA 操作进行后处理或进行下一次 DMA 传送的预处理。
##### DMA 数据传输过程：
![[../../Picture/Pasted image 20241130145914.png]]
**预处理阶段**：对 DMA 控制器进行一些初始设置，比如： 内存首地址、数据长度、数据传送方式等。
**数据传送阶段**：DMA 控制器接管总线后进行的真正数据传输。
**后处理阶段**：数据传输结束后，DMA 控制器通过中断机制通知 CPU，然后 CPU 通过中断做该做的事。

## [[../../Contents/第六章 输入输出系统|回到目录]]