### 5.3.1 内存可靠性
#### 5.3.1.1 可靠性
**故障**：组件的失效，可能（但不一定）导致整个系统的失效
**服务完成**：按规定交付的服务，失效 $\Rightarrow$ **服务中断**
**服务中断**：偏离规定的服务，恢复 $\Rightarrow$ **服务完成**
#### 5.3.1.2 可靠性的度量
**正常运行时间**——平均故障时间 (MTTF)
**服务中断时间**——平均修复时间 (MTTR)
**平均的故障间隔时间**：MTBF = MTTF + MTTR
**可用性** = $\frac{MTTF}{(MTTF + MTTR)}=\frac{正常运行时间}{(正常运行时间 + 服务中断时间)}$ 
**提升可用性**：提高 MTTF 和降低 MTTR
#### 5.3.1.3 可靠性问题
存储中的可靠性（时间）
通信中的可靠性（空间）
**利用冗余改善可靠性**：
3 倍重复编码：将要传递的信息重复 3 次，根据多数投票确定结果
（错两位的概率远小于错一位的概率）
### 5.3.2 纠错
#### 5.3.2.1 汉明距离与最小汉明距离
定义：两个等长的 0/1 序列中，对应位置值上不同的数目
最小汉明距离与检错、纠错能力
最小海明距离为 d ：可以实现 d-1 位**检错**；$\frac{d-1}{2}$ 位**纠错**
#### 5.3.2.2 编码效率
**编码效率**的定义：
$\text{编码效率}=\frac{有效信息 bits}{整体信息 bits}$
编码效率很重要
编码效率若太低：降低了通信带宽，浪费了存储资源
#### 5.3.2.3 奇偶校验编码
汉明距离为 2
##### 奇偶校验编码规则
- **目的**：利用一位 bit 来计算 bit 序列中 1 的个数，以实现奇偶校验。
- **奇数个 1**：如果序列中 1 的个数为奇数，则校验位设为 1。
- **偶数个 1**：如果序列中 1 的个数为偶数，则校验位设为 0。
- **实现方法**：通过异或（XOR）逻辑来计算校验位。
##### 校验实现过程
1. **写时生成校验位**：在写入数据时，计算数据位中 1 的个数，根据奇偶性设置校验位。
2. **读时检查校验位**：在读出数据时，重新计算 1 的个数，并与校验位比较，以检查数据是否在传输过程中出现错误。
##### 检测能力
- **检测错误**：能够检测奇数个错误。
- **纠正错误**：不能纠正错误。
#### 5.3.2.4 SEC (Single Error Correction) 编码
- 编码方案：p 表示校验位，d 表示数据位，$p_k$ 是位置编号第 k 位为 1 的 bit 值的偶校验
- 校验位的位置为 2 的幂（1, 2, 4, 8, ...）
- 每个校验位只检查特定的数据位
##### SEC 编码 (7, 4)
- **数据位数目（d）**：4
- **校验位数目（p）**：3
- **总位数（n）**：p + d = 3 + 4 = 7
![[../../Picture/Pasted image 20241212231205.png]]
![[../../Picture/Pasted image 20241212231149.png]]
##### 编码效率
- **编码效率计算**：( $\frac{d}{n} = \frac{4}{7}$ )
**分析**:
- **可能出错的状态**：n 位可能出错，且可能都不出错，总共有 n+1 个状态。
- **校验位表示的状态**：p 个校验位可以表示\( $2^p$\) 个状态。
- **状态数量条件**：为了保证能够检测和纠正错误，需要满足( $2^p \geq n + 1$)。
##### 扩展的汉明编码：SEC/DEC Code
为整个序列添加额外的校验位，称为$p_n$
汉明距离 = 4：可以检错 2 个 bit 位, 纠错 1 个 bit 位
**解码规则**：假设 H = SEC 校验位 
如果 H 偶数, pn 偶数, 则没有错误 
如果 H 奇数, pn 偶数, 则发生了可纠正的、单 bit 错误 
如果 H 偶数, pn 奇数, 则在 pn 位发生了错误（可纠正) 
如果 H 奇数, pn 偶数, 则发生了 2 个 bit 的错误 (不可纠正)
**注意**: ECC DRAM 使用 SEC/DEC，用 8 位校验码来保护 64 位
### 5.3.3 虚拟内存
#### 5.3.3.1 虚拟机
**虚拟机**：主机计算机模拟客户操作系统和机器资源。
- 改进了多个客户之间的隔离。避免了安全和可靠性问题。有助于资源共享。
- 虚拟化对性能有一定影响。
**虚拟机监视器 (VMM)**:将虚拟资源映射到物理资源（如内存、I/O 设备、CPU）。
- 客户代码在本地机器上以用户模式运行。
- 在执行特权指令和访问受保护资源时，向 VMM 发送陷阱。
- 客户操作系统可能与主机操作系统不同。
- VMM 处理实际的 I/O 设备。为客户模拟通用的虚拟 I/O 设备。
##### **计时器虚拟化示例**
**在原生机器上，计时器中断时**：
- 操作系统挂起当前进程，处理中断，选择并恢复下一个进程。 
**使用虚拟机监视器时**：
- VMM 挂起当前虚拟机，处理中断，选择并恢复下一个虚拟机。
**如果虚拟机需要计时器中断**：
- VMM 模拟一个虚拟计时器。
- 当物理计时器中断发生时，为虚拟机模拟中断。
##### 指令集支持: 用户和系统模式。
- 特权指令只在系统模式下可用。如果在用户模式下执行，则触发系统陷阱。
- 所有物理资源只能使用特权指令访问（包括页表、中断控制、I/O 寄存器）。
- 虚拟化支持的复兴：当前 ISA（例如 x86）正在适应。

#### 5.3.3.2 虚拟内存
**虚拟内存**：将主内存用作二级（磁盘）存储的“缓存”。
**由 CPU 硬件和操作系统（OS）共同管理**：
- 程序共享主内存。
- 每个程序获得一个私有的虚拟地址空间，包含其经常使用的代码和数据。
- 受到其他程序的保护。
- CPU 和 OS 将虚拟地址转换为物理地址，增加各个程序地址之间的**保护**
虚拟内存“块”称为页面。虚拟内存转换“未命中”称为页面错误。
##### 地址转换
虚拟内存还通过**重定位**简化了执行时程序的载入。
在用地址访问存储之前，重定位将程序使用的虚拟地址映射到不同的物理地址。重定位允许将程序载入主存中的任何位置。
虚拟存储系统都将程序重定位成一组固定大小的块 (页)，从而不需要寻找连续内存块来放置程序; 相反，操作系统只需要在主存中**找到足够数量的页**。
![[../../Picture/Pasted image 20241213105958.png]]

##### 页面错误惩罚
- 页面错误时，必须从磁盘获取页面。
- 需要数百万时钟周期。
- 由操作系统代码处理。
- 尝试最小化页面错误率。
- 全相联放置。
- 智能替换算法。
##### 页面表
- 存储放置信息。
- 页面表条目数组，由虚拟页号索引。
- CPU 中的页面表寄存器指向物理内存中的页面表。
- 如果页面在内存中：
  - PTE 存储物理页号和其他状态位（引用、脏等）。
- 如果页面不在内存中：
  - PTE 可以指向磁盘上的交换空间位置。
使用页面表进行转换：将页面映射到存储
#### 5.3.3.3 替换和写入

- 为了减少页面错误率，优先使用最近最少使用（LRU）替换。
- 引用位（又称使用位）在访问页面时设置为 1。
- 操作系统定期将其清除为 0。
- 引用位=0 的页面最近没有被使用。
- 磁盘写入需要数百万周期。
- 一次写入一个块，而不是单个位置。
- 写入不切实际。
- 使用写回。
- 页面被写入时，PTE 中的脏位被设置。
### 5.3.4 加快地址转换：TLB
#### 5.3.4.0 TLB 简介 [[../../Files/Textbook/计算机组成与设计：硬件／软件接口 RISC-V版（原书第2版）.pdf|P338]]
现代处理器包含一个特殊的 cache 以追踪记录最近使用过的地址转换。这个特殊的地址转换 cache 通常被称为快表 (TLB)(将其称为地址转换 cache 会更加准确)。
![[../../Picture/Pasted image 20241213114545.png]]
#### 5.3.4.1 使用 TLB 进行快速转换
![[../../Picture/Pasted image 20241213113621.png]]
- 地址转换似乎需要额外的内存引用。一次访问 PTE，然后实际内存访问。
- 但访问页面表具有良好的局部性。因此，在 CPU 内使用快速 PTE 缓存。
- 称为转换旁路缓冲器（TLB）。
- 典型：16-512 PTEs，命中 0.5-1 周期，未命中 10-100 周期，未命中率 0.01%-1%。
- 未命中可以由硬件或软件处理。
#### 5.3.4.2 TLB 未命中的处理
- 如果页面在内存中：
  - 从内存中加载 PTE 并重试。
  - 可以由硬件处理。
  - 对于更复杂的页面表结构可能变得复杂。
- 或者在软件中处理：
  - 引发特殊异常，具有优化的处理程序。
- 如果页面不在内存中（页面错误）：
  - 操作系统处理获取页面和更新页面表。
  - 然后重新启动引发错误的指令。
##### TLB 未命中处理程序
TLB 未命中表明：
1.页面存在，但 PTE 不在 TLB 中。
2.页面不存在。
- 必须在目标寄存器被覆盖之前识别 TLB 未命中，并引发异常。
- 处理程序将 PTE 从内存复制到 TLB，然后重新启动指令。
- 如果页面不存在，将发生页面错误。
##### 页面错误处理程序
使用引发错误的虚拟地址找到 PTE。
在磁盘上定位页面。
选择要替换的页面。
如果脏了，先写入磁盘。
将页面读入内存并更新页面表。
使进程再次可运行。
从引发错误的指令重新开始。

#### 5.3.4.3 TLB 和缓存交互
- 如果缓存标签使用**物理地址**：
  - 需要在缓存查找之前进行转换。
- 或者使用**虚拟地址**标签：
  - 由于别名问题而产生复杂性。
  - 不同的虚拟地址对应共享的物理地址。
#### 5.3.4.4 内存保护
- 不同任务可以共享其虚拟地址空间的部分。
- 但需要防止错误的访问。
- 需要操作系统的帮助。
- 硬件支持操作系统保护。
- 特权管理模式（又称内核模式）。
- 特权指令。
- 页面表和其他状态信息只能在管理模式下访问。
- 系统调用异常（例如，RISC-V 中的 ecall）。



### [[../../Contents/第五章 多层次存储|回到目录]]
