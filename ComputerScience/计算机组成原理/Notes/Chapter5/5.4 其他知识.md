### 5.4.1 内存层次结构
在内存层次结构的所有级别上都适用共同的原则。
![[../../Picture/Pasted image 20241213114817.png]]
- 基于缓存的概念。在层次结构的每个级别上：
  - 块放置
  - 查找一个块
  - 未命中时的替换
  - 写入策略
#### 5.4.1.1 块放置：由关联性决定。
![[../../Picture/Pasted image 20241213114905.png]]
![[../../Picture/Pasted image 20241213114923.png]]
- 直接映射（1 路关联）：
  - 放置位置只有一个选择。
- n 路集合关联：
  - 在集合中有 n 个选择。
- 全关联：
  - 任何位置。
- **更高的关联性降低未命中率**
  - 增加复杂性、成本和访问时间。

#### 5.4.1.2查找一个块
![[../../Picture/Pasted image 20241213115026.png]]
**硬件缓存**：
- 减少比较以降低成本。
**虚拟内存**：
- 全表查找使全关联变得可行。
- 减少未命中率的好处。
**使用全相联映射和额外页表原因**：
- 全相联有其优越性，因为失效代价非常高。
- 全相联允许软件使用复杂的替换策略以降低失效率。
- 全相联很容易索引，不需要额外的硬件，也不需要进行查找。
因此，虚拟存储系统通常使用全相联。
#### 5.4.1.3 cache 发生失效时替换哪一块
**直接映射**：只能替换一块
**全相联 cache**：所有块都可以
**组相联 cache**：一组的块中进行选择 
全相联和组相联的**替换策略**：[[5.2 缓存#5.2.3.5 替换策略|参考替换策略]]
- 最近最少使用（LRU）：
  - 对于高关联性，硬件复杂且成本高。
- 随机：
  - 接近 LRU，更容易实现。
- 虚拟内存：
  - 使用硬件支持的 LRU 近似。
#### 5.4.1.4 写入策略
- 写入通过：
  - 更新上下两级。
  - 简化替换，但可能需要写入缓冲区。
- 写回：
  - 仅更新上级。
  - 在替换块时更新下级。
  - 需要保持更多的状态。
- 虚拟内存：
  - 鉴于磁盘写入延迟，只有写回是可行的。

### 5.4.2 其他知识
#### 未命中的来源
- 强制未命中（又称冷启动未命中）：
  - 对一个块的首次访问。
- 容量未命中：
  - 由于缓存大小有限。
  - 被替换的块后来再次被访问。
- 冲突未命中（又称碰撞未命中）：
  - 在非全关联缓存中。
  - 由于集合中条目的竞争。
  - 在相同总大小的全关联缓存中不会发生。
#### 缓存设计权衡
- 设计变化对未命中率的影响负面性能影响：
  - 增加缓存大小：减少容量未命中，可能增加访问时间。
  - 增加关联性：减少冲突未命中，可能增加访问时间。
  - 增加块大小：减少强制未命中，增加未命中惩罚。对于非常大的块大小，由于污染可能会增加未命中率。
### [[../../Files/Textbook/计算机组成与设计：硬件／软件接口 RISC-V版（原书第2版）.pdf|参考P346]]
### [[../../Contents/第五章 多层次存储|回到目录]]