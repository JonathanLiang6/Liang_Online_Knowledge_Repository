### 4.0.1 CPU 预览
[[#4.0.4|CPU预览图]]
#### 4.0.1.1 数据通路
RISC-V 实现中的数据通路包含两种不同类型的逻辑单元：
1. 处理数据值的单元：组合逻辑单元 `e.g ALU`
2. 存储状态的单元：状态(逻辑)单元 `e.g 寄存器，指令存储器，数据存储器`
	状态单元至少有两个输入和一个输出，必须的输入是写入状态单元的数据和何时写入的时钟信号
#### 4.0.1.2 逻辑设计基础
信息使用二进制进行编码: 低电平 0；高电平 1.
每条线传输一个 bit $\Rightarrow$ 多 bit 数据使用多条线构成的总线传输
**组合逻辑：** 输出只是输入的函数，输出仅取决于当前的输入
**状态逻辑/时序逻辑：** 可以存储信息，输出取决于输入和内部状态
### 4.0.2 组合逻辑
#### 4.0.2.1 基本逻辑门介绍
**与或非门：** 对应& | ^三种操作
![[../../Picture/Pasted image 20241120140908.png]]

**选择器：** 逻辑上等价于C = S ? A : B	// S为真执行A；S为假执行B
**加法器：** C = A + B
对于多 bit 门，采用并行计算
#### 4.0.2.2 算术逻辑单元ALU
一种示例组成：与门+或门+选择器
![[../../Picture/Pasted image 20241120143245.png]]
![[../../Picture/Pasted image 20241120145700.png]]

### 4.0.3 状态逻辑/时序逻辑
#### 4.0.3.1 基本介绍
**寄存器：** 在电路中存储数据
使用一个时钟信号确定何时更新存储的数据，**边缘触发：** 当时钟 0 $\rightarrow$ 1 时触发信号
具有**写控制信号**的寄存器：在时钟边缘&写控制信号为 1，才更新数据
用于后续需要使用存储的数据
#### 4.0.3.2 寄存器文件
寄存器文件：由 D 触发器构成的寄存器数组，支持读、写操作  ^bc4cbe
- 寄存器号用来索引具体的寄存器
- 每个读端口需要一个选择器；每个写端口需要一个译码器
![[../../Picture/Pasted image 20241120152355.png]]
#### 4.0.3.3 时钟方法
组合逻辑需要完成运算和数据传输：
1. **时钟周期内完成的任务**：
 在每个时钟周期内(即两个时钟边缘之间)，组合逻辑需要完成其运算和数据传输的任务。
2. **状态逻辑的交互**：
组合逻辑从一个状态逻辑获取输入，并将其输出写入下一个状态逻辑。
3. **时钟周期的决定因素**：
最长的延迟（Longest delay）决定了时钟周期的长度。这是因为时钟周期需要足够长，以确保电路中的所有组合逻辑部分都能在这个时间内完成它们的任务。
4. **确保时钟周期长度**：
必须确保时钟周期的长度足够，以便每个组合逻辑部分能完成信息的读写和计算过程。
5. **信息的稳定性**：
读取到的信息必须是上一个周期更新后的、稳定的状态，而不是正处于变化过程中的不稳定状态。因为在数字电路中，不稳定的信号可能会导致错误的逻辑判断和计算结果。
#### 4.0.3.4 实现：边缘触发的方法
**方法一：上升沿边缘触发的方法:**
1. **在时钟上升沿**：将计算结果写入**状态逻辑** 1 和 2。
2. **持续**读取**状态逻辑 1** 的内容：读取过程无需时钟信号的控制。
3. **持续**计算读取的内容：**组合逻辑**完成计算。
   - 在时钟开始上升沿，前面组合逻辑的输出写入状态逻辑 1，作为当前逻辑的**输入**。
   - 时钟周期前半段，**持续读取**的输入和**持续计算**的值可能不稳定。
   - 在 t+1 时钟开始上升沿，当前组合逻辑的输出值开始写入状态逻辑 2。
4. **保证时钟周期内完成**：在 t+1 时钟开始之前，能够完成状态逻辑 1 上升沿写入+状态逻辑 1 持续读取+计算。
![[../../Picture/Pasted image 20241120233501.png]]
**方法二：边缘触发方法**
**允许一个状态逻辑在同一个时钟周期内完成写和读**：而不会导致不稳定的状态。
   - 默认每个时钟都会更新状态逻辑；否则，需要额外的写控制信号。
   - 只有写控制为 1，且时钟边缘达到时，才更新。
![[../../Picture/Pasted image 20241120233510.png]]
### 4.0.4 CPU 组件
#### 4.0.4.1 CPU 全览
![[../../Picture/1111.png]]
![[../../Picture/Pasted image 20241124190120.png]]
#### 4.0.4.2 CPU 组件介绍
每条指令的执行都会读取和更新状态，下面介绍并讨论各种数据通路单元
1. **存储单元（指令存储器）**
存储程序的指令，并根据给定的地址提供指令
 2. **程序计数器（PC）**
记录和更新当前指令的地址
3. **加法器**（由 ALU 实现）
增加 PC 的值从而获取下一条指令的地址
4. **寄存器**（x0~x31）
寄存器文件 Reg 包括 32 个 64 位寄存器
- 指令中的 rs1，rs2 字段指定第一，第二个**读寄存器**（来源）
- 指令中的 rd 字段，指定**写寄存器**（目的）
- x0 永远是 0（写入 Reg\[0] 会忽略**写操作**）
5. **内存** (MEM) ：可以存储指令和数据，字节寻址 
- 分开使用指令内存 (IMEM) 和数据内存 (DMEM) 
	- 简化版本中, 内存是异步读 (not clocked), 同步写 (is clocked)
- 从**指令内存**读取指令——可假设 IMEM 是只读的 
- load 指令/store 指令才会访问**数据内存**
#### 4.0.4.3 单周期 RISC-V 机器介绍
当前状态作为**组合逻辑**的输入，组合逻辑进行运算，在**下一个时钟上升沿**：组合逻辑输出会更新所有的状态逻辑。之后，开始下一个时钟的操作：读取-计算-更新
各种**操作**细节如下：
- 读/写 PC ：每条指令 
- 读/写 DMEM：load/store 指令 
- 读/写 reg：每条指令/R 型指令 
- 读 IMEM：每条指令

### [[../../Contents/第四章 处理器|回到目录]]