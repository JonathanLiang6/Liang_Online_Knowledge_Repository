### 4.2.1 IPv4 分组
![[../../CN_Picture/Pasted image 20251228145600.png]]
### 4.2.2 IP 地址
![[../../CN_Picture/Pasted image 20251228153455.png]]
![[../../CN_Picture/Pasted image 20251228165703.png]]
### 4.2.3 子网划分技术
#### 4.2.3.1 子网划分原理
- 租用 IP 地址段后，把原主机号的前 k bit 抠出作为子网号，剩余 （n-k） bit 仍为主机号，可得到 2^k 个子网，每个子网地址块大小相等。  
- 划分前：IP 地址为两级结构 = <网络号, 主机号>。  
- 划分后：IP 地址为三级结构 = <网络号, 子网号, 主机号>。
- **地址使用规则**：每个子网中，主机号全 0 表示子网本身，全 1 为子网广播地址，均不能分配给节点。
#### 4.2.3.2 子网掩码作用
- 用子网掩码与 IP 地址“**逐位与**”得到<网络号, 子网号>(合称“网络前缀”)  
- 只有网络前缀相同的 IP 地址才属于同一网络（或子网）。
#### 4.2.3.3 配置要点
- 网络内每台主机、每个路由器接口都需配置 IP 地址、默认网关、子网掩码。  
- 若路由器支持子网划分，其转发表需包含<目的网络号, 子网掩码, 转发接口>
#### 4.2.3.4 默认配置
- 传统网络未划分子网时，使用**默认子网掩码**：  
  - A 类：255.0.0.0  
  - B 类：255.255.0.0  
  - C 类：255.255.255.0 
- **默认路由**
	- 转发表项：<目的网络号全 0, 子网掩码全 0> 
	- 当所有表项都不匹配时，按默认路由转发。

### 4.2.4 无分类编址 CIDR
#### 4.2.4.1 CIDR 基本原理
- 取消传统 A/B/C/D/E 分类，采用无分类编址 CIDR，IP 地址块分配更灵活，利用率更高，缓解 IP 地址耗尽（1993 年提出）。  
- IP 地址结构：IP 地址 = {&lt; 网络前缀&gt;, 主机号}，网络前缀长度不固定。  
- CIDR 记法示例：128.14.32.153/30，表示网络前缀占 30bit，主机号占 2bit。
#### 4.2.4.2 子网划分方式
| 方式 | 特点 | 结果 |
| --- | --- | --- |
| 定长子网划分 | 主机号前 k 位作为子网号，长度固定 | 划分出 2^k 个子网，每个子网 IP 地址块大小相等 |
| 变长子网划分 | 子网号长度不固定 | 各子网 IP 地址块大小不同 |
- 每个子网中，主机号全 0（网络地址）和全 1（广播地址）的 IP 地址不能分配给特定节点私用。
#### 4.2.4.4 解题技巧（二叉树法）
- 原始 CIDR 地址块作为根节点，假设可自由分配的主机号占 h 位。  
- 每个分支节点必须同时拥有左右孩子：左 0 右 1（或相反）。  
- 每个叶子节点对应一个子网，根据根到叶的路径分析子网 IP 地址块范围。  
- 整棵树高度不超过 h-1（最小子网至少保留 2 位主机号）。
### 4.2.5 路由聚合
### 4.2.5 路由聚合
#### 4.2.5.1 定义
对于一个路由转发表，如果几条路由表项的转发接口相同、部分网络前缀也相同，那么可以将这几条路由表项聚合为一条。这种地址的聚合称为**路由聚合**，也称**构成超网**。
- 路由聚合可以减少路由表的大小。  
- 路由聚合可能会引入额外的无效地址。
#### 4.2.5.2 最长前缀匹配原则
采用 CIDR 技术后，由于“路由聚合”，一个 IP 地址在转发表中可能会匹配多个表项，此时应使用最长前缀匹配原则：选择网络前缀最长的那条路由表项进行转发。
#### 4.2.5.4 主机发送 IP 数据报的过程（CIDR 环境下）
1. 判断目的主机与本机是否属于同一网络  
   ① 用本机配置的子网掩码对“本机 IP 地址”和“目的 IP 地址”逐位与，得到各自网络前缀。  
   ② 若网络前缀相同 → 同一网络；不同 → 不同网络。
2. 将 IP 数据报封装成 MAC 帧并发送到链路  
   - 若同一网络：通过 ARP 获取目的主机 MAC 地址，把帧直接发给目的主机。  
   - 若不同网络：通过 ARP 获取默认网关 MAC 地址，把帧发给默认网关，由网关继续转发。  
#### 4.2.5.4 路由器转发 IP 数据报的过程
1. 对 IP 数据报首部进行校验，并从中找到目的 IP 地址。  
2. 查“转发表”：将目的 IP 地址与每个表项的子网掩码“逐位与”，匹配表项中的目的网络号。  
   - 注：至少“默认路由”表项一定是可以匹配成功的。  
   - 若匹配多个表项，按最长前缀匹配原则选择。  
3. 转发：根据查表结果，将 IP 数据报从匹配的接口转发出去。  
   - 注：如果匹配的“转发接口”和该 IP 数据报的入口相同，就不用再把 IP 数据报转发回去。
### 4.2.6 网络地址转换 NAT
#### 4.2.6.1 IP 地址
##### 私有 IP 地址（内网 IP）
- 地址范围：
  - 10.0.0.0 ~ 10.255.255.255
  - 172.16.0.0 ~ 172.31.255.255
  - 192.168.0.0 ~ 192.168.255.255
- 只允许分配给局域网内部节点，不允许分配给互联网上节点。  
- 每个局域网内部可自行分配，只要求局域网内唯一，不要求全球唯一，因此**可复用**。
##### 全球 IP 地址（外网 IP）
- 通常由 ISP 提供，全球唯一。  
- 外网 IP 是局域网与外界通信时所需使用的 IP 地址。
#### 4.2.6.2 NAT 路由器
- **作用**：转发 IP 数据报时进行内网 IP 与外网 IP 的相互转换。  
- NAT 表：记录地址转换关系，格式为 $<内网IP:端口号 \Leftrightarrow外网IP:端口号>$
- **从内网转发到外网**：更改源 IP 地址、源端口号。  
- **从外网转发到内网**：更改目的 IP 地址、目的端口号。  
- **区别于普通路由器**：NAT 路由器包含传输层功能（因端口号属传输层概念）。
- **普通路由器转发行为**：转发 IP 数据报时不会改变源 IP、目的 IP 地址。仅具备网络层功能。 
![[../../CN_Picture/Pasted image 20251230012552.png]]
上图为训练 3 示意图
### 4.2.7 地址解析协议 ARP
#### 4.2.7.1 基础概念
- MAC 地址 48 bit，出厂时写入网络适配器，全球唯一。  
- 主机至少一个网络适配器→至少一个 MAC 地址；路由器每接口一个适配器→多个 MAC 地址。  
- **ARP 作用**：在同一局域网内，根据已知 IP 地址查询对应 MAC 地址。
- **ARP 表（ARP 缓存）**
	- 每台主机/路由器维护，记录 (IP 地址→MAC 地址) 映射。  
	- 需定期更新表项防止失效。
#### 4.2.7.2 ARP 工作过程
1. **ARP 请求分组**  
   - 内容：  
     – 我是谁？我的 IP 地址是 X，我的 MAC 地址是 Y  
     – 我想找谁？目标 IP 地址 Z  
   - 封装成广播帧：目的 MAC=全 1，源 MAC=Y，在局域网内广播。
2. **ARP 响应分组**  
   - 只有 IP=Z 的主机回复：  
     – 内容：我的 IP 地址是 Z，我的 MAC 地址是 V  
   - 封装成单播帧：目的 MAC=Y，源 MAC=V，直接发回请求方。
请求方收到响应后，把 (Z, V) 写入 ARP 表，完成地址解析。
### 4.2.8 动态主机配置协议 DHCP
#### 4.2.8.1 作用与模型
- **作用**：给刚接入网络的主机动态分配 IP 地址、配置默认网关、子网掩码等。  
- **模型**：客户/服务器（C/S）。  
  - DHCP 客户：新接入的主机。  
  - DHCP 服务器：管理 IP 地址池；家庭网络中通常由家用路由器兼任；大型网络可设多台服务器。  
- **协议栈**：应用层协议，基于 UDP，客户端口 68，服务器端口 67。
#### 4.2.8.2 四步交互（广播阶段源 IP 均为 0.0.0.0）
1. DHCP 发现报文（DISCOVER）  
   客户→服务器：  
   - 网络层：源 0.0.0.0，目的 255.255.255.255（广播 IP 数据报）。  
   - 链路层：源 MAC=客户 MAC，目的 MAC=全 1（广播帧）。  
   - 携带：客户 MAC、可提出租用期要求。
2. DHCP 提供报文（OFFER）  
   服务器→客户：  
   - 网络层：源=服务器 IP，目的 255.255.255.255（广播 IP 数据报）。  
   - 链路层：源 MAC=服务器 MAC，目的 MAC=客户 MAC（单播帧）。  
   - 携带：拟分配的 IP、租用期、子网掩码、默认网关。
3. DHCP 请求报文（REQUEST）  
   客户→服务器：确认要使用的 IP。  
   - 网络层与链路层广播方式同①。  
4. DHCP 确认报文（ACKNOWLEDGE）  
   服务器→客户：正式确认参数。  
   - 网络层与链路层单播方式同②，内容同提供报文。  
完成四步后，客户获得合法配置并加入网络。
### 4.2.9 ICMP 网际控制报文协议
#### 4.2.9.1 协议定位
- ICMP 属于网络层，报文直接封装在 IP 数据报中，协议字段 = 1。  
- 作用：让主机或路由器互相报告网络中的差错和异常情况。
#### 4.2.9.2 差错报告报文（5 种常用类型）
| 类型 | 发送方 | 含义 |
| --- | --- | --- |
| 终点不可达 | 路由器或目的主机 | 道路不通；目的端口号不存在 |
| 时间超过 | 路由器或目的主机 | TTL=0 被丢弃；分片未按时到齐被丢弃 |
| 参数问题 | 路由器或目的主机 | IP 首部字段非法或校验错误 |
| 改变路由（重定向） | 路由器 | 提示发送方：下次换另一台路由器转发路径更短 |
| 源点抑制（已废弃） | —— | 2012 年后不再使用 |
#### 4.2.9.3 询问报文
1. 回送请求 / 回送回答（Echo Request / Reply）  
   例：A→B：在吗？B→A：在！（ping 即基于此实现）
2. 时间戳请求 / 时间戳回答（Timestamp Request / Reply）  
   用于同步两端时钟：A 问 B 当前时间，B 回送收到与发出时刻。
#### 4.2.9.4 不再反馈 ICMP 差错的场景
- 携带 ICMP 差错报告报文的 IP 数据报本身出错；  
- IP 数据报被分片后，无论几个分片出错，只反馈一次 ICMP 差错；  
- 目的地址为多播地址；  
- 源地址为特殊地址（127.x.x.x、0.0.0.0 等）。
#### 4.2.9.5 典型应用
- **ping**：基于回送请求/回答报文检测连通性。  
- **traceroute / tracert**：基于时间超过报文追踪路径。
### [[第四章 网络层|回到目录]]