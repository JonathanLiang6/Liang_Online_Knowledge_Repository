### 4.4.0 二者关系
![[../../CN_Picture/Pasted image 20251228173029.png]]
### 4.4.1 路由算法
#### 4.4.1.1 目标与角色
- **目标**：找到转发 IP 分组的“最佳路径”。  
- **路由协议**：实现某种路由算法，并定义路由器之间如何交换信息，以获取算法所需数据。
#### 4.4.1.2 静态 vs 动态路由算法
| 类型     | 配置方式             | 特点               | 适用场景 |
| ------ | ---------------- | ---------------- | ---- |
| 静态路由算法 | 网络管理员手工配置每一条路由   | 实现简单、开销小、无自适应能力  | 小型网络 |
| 动态路由算法 | 路由器根据网络变化自动调整路由表 | 实现复杂、开销大、具备自适应能力 | 大型网络 |
#### 4.4.1.3 常见动态路由算法
| 算法类别     | 本质                      | 特点                                    | 代表协议 |
| -------- | ----------------------- | ------------------------------------- | ---- |
| 距离向量路由算法 | Bellman-Ford 算法在路由领域的应用 | 路由器只需关心自己与邻居的距离，以及邻居到目的网络的最短距离；无需完整拓扑 | RIP  |
| 链路状态路由算法 | Dijkstra 算法在路由领域的应用     | 路由器必须获得完整网络拓扑，再用 Dijkstra 计算最短路径      | OSPF |
| 路径向量路由算法 |                         |                                       | BGP  |
### 4.4.2 分层次的路由协议
#### 4.4.2.1 自治系统 AS
- 全世界的互联网被划分为相互独立的**自治系统** AS  
- AS 管理单位有权决定在本自治系统内使用何种**内部路由协议**（RIP，OSPF）
- 每个 AS 至少有一台**自治系统边界路由器**与其他自治系统相连
- 各**边界路由器**之间，使用统一外部路由协议
- 每个自治系统都有**全球唯一**的 AS 编号（ASN）。
- 自治系统之间是**平级关系**，不存在包含关系。 
- 一个自治系统通常包含一个/多个 **CIDR** 地址块，便于路由聚合
#### 4.4.2.2 按使用范围划分
- 自治系统边界路由器和其他 AS 相连，各个自治系统边界路由器之间统一使用 BGP 协议相互交换路由信息，形成**分层次的路由协议**架构。
- 网关=路由器
- **内部网关协议**（IGP）/域间路由选择：用于自治系统内部的路由选择。例如 RIP、OSPF 属于 IGP。一个自治系统有权决定在本自治系统内使用哪种内部网关协议。  
- **外部网关协议**（EGP）/域内路由选择：用于自治系统之间的路由选择。例如 BGP 属于 EGP。
### 4.4.3 RIP：路由信息协议
#### 4.4.3.1 RIP 的基本概念
- **RIP 在协议栈中的位置**：RIP 属于**应用层**，使用 **UDP** 传送数据（端口=520）
	1. 报文种类
	    - Request（请求）作用：向邻居索要完整路由表，用于路由器刚启动或手动查询。
	    - Response（响应）作用：a回复邻居的 Request；b周期性地主动广播/组播给邻居，通告自身路由信息。
	2. 报文大小限制
	    - 一个 Response 报文最多只能携带 25 条路由表项。若本地路由表 > 25 条，则必须拆成多个 Response 报文分批发送。
- **RIP 路径长度定义**：
	1. RIP 使用跳数（Hop Count，或称距离）来衡量到达目的网络的距离。  
    规定：路由器到“直连网络”的距离 = 1，每多经过一台路由器，距离再加 1
	2. RIP 认为“好的路由”就是跳数**最少**的路由；跳数越少，优先级越高。
	3. RIP 规定一条**合法路径**的跳数不能超过 15，跳数 = 16 时即视为“不可达”。  
	    因此 RIP 只能用于**规模较小**的自治系统（AS）。
- **RIP 路由表格式定义**：
	1. 每个路由器维护一张路由表，表项的关键**三元组**格式为：  
	    **<目的网络 N，距离 d，下一跳路由器地址 X>**
	2. 每个路由器都要保存“从自己到所有已知目的网络”的距离记录，这组记录就是**距离向量**
	    实际上这些向量已经包含在路由表里（距离 d），RIP 协议用“距离向量路由算法”周期性地与邻居交换整张表，并依此算出最短路径。
- **RIP 路由信息交换**
	1. **和谁交换**：仅与“直接相邻”的路由器交换，不相邻的不通信。
	2. **交换什么**：把自己的整张路由表毫无保留地发给邻居；  
	    路由表 = 当前路由器所知道的“全部信息”。
	3. **何时交换**：按照固定时间间隔(通常为 30s)周期性地发送一次。
    - **加速** RIP 收敛：**触发更新机制**（Triggered Update）：一旦检测到链路/拓扑变化，立即向邻居推送更新，不必等下一个 30 s，用来加快收敛。
#### 4.4.3.2 RIP 的工作过程（基于距离向量算法）
- **周期**：30 秒  
- **初始状态**：从路由器启动到收敛
	- 各路由器同时开机，构建初始路由表;路由器刚启动时仅知道自己到直连网络的距离为 1  
	- 各路由器仅与相邻路由器**周期性（30s）** 交换并更新路由信息，即收到**邻居**的 RIP 报文后，**更新自己**的路由信息
	- 最终所有路由器都知道本 AS 内任一网络的最短距离及下一跳地址，称为**收敛**
##### 对接收到的 RIP 报文（来自相邻路由器 X）的**处理步骤**：
1. **修改报文项目**  
   - 把“下一跳”字段全部改为 X；把所有“距离”字段值加 1
2. **逐项比较并更新本地路由表**  
   ① 若本地无目的网络 N → 添加新项目（发现新网络）  
   ② 若本地已有 N 且原下一跳为 X → 用收到的项目替换（老路距离变化，以最新消息为准）  
   ③ 若本地已有 N 但原下一跳不是 X → 仅当收到项目距离更小才更新（找到更短路径）  
   ④ 其他情况 → 不动作
3. **超时处理**：若 180 秒（默认超时时间）未收到某相邻路由器更新，则将其标记为不可达，距离置 16
4. **返回**
#### 4.4.3.3 RIP 的优点
1. 实现简单、开销小、收敛过程较快。  
2. 若一个路由器发现了更短的路由，则这种更新信息就传播得很快，在较短时间内便可被传至所有路由器，俗称“好消息传播得快”。
#### 4.4.3.4 RIP 的缺点
1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。 
2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。  
3. 当网络出现故障时，路由器之间需反复多次交换信息才能完成收敛，要经过较长时间才能将故障消息传送到所有路由器（**慢收敛现象**），俗称“坏消息传播得慢”。  
注：距离向量路由可能会出现环路的情况，RIP 规定路径上的最高跳数=16 是一种防止环路的简单粗暴的方式。
### 4.4.4 OSPF：开放最短路径优先协议
#### 4.4.4.1 OSPF 特点
- OSPF 属于**网络层**，直接使用 IP 协议提供服务，IP 首部协议字段 = 89
- OSPF 基于**链路状态路由算法**（Dijkstra 算法）计算最佳转发路径。  
	1. 每台路由器都需建立**整个网络**的拓扑图（带权有向图，可用邻接表存储）
	2. 路由器开机时探测与自己直连的所有链路状态
	3. 用**洪泛法**将探测到的链路状态信息迅速发给其他路由器；每个链路状态信息都带上一个 32 位序号，序号越大状态越新。
	- **洪泛法**：除了入口全部转发，不可回流，重复的信息不重复转发
	4. 若路由器探测到身边链路有变化，就再次立即**洪泛**最新的链路状态信息。  
- OSPF 默认根据带宽计算链路**代价**=参考带宽=100MBps/接口带宽
	- 一段链路的两个方向权值可能不同
	- 直连网络 $\Rightarrow$ 路由器方向权值通常为 0
- **OSPF 特点**：
	1. OSPF 支持等价多路径转发。  
	2. OSPF 分组支持鉴别功能，防止非法路由信息在自治系统内传播。  
	3. OSPF 支持变长子网划分、无分类CIDR。
	4. 每个链路状态上都带上一个 32 位的序号，序号越大，状态就越新
#### 4.4.4.2 OSPF 基本工作原理
##### 生成路由表方法
1. **构建 LSDB**：路由器用**洪泛法**将探测到的链路状态信息迅速发给其他路由器；一旦探测到身边链路有变化，就再次立即洪泛最新的链路状态信息。各台路由器根据收到的链路状态信息构建 LSDB（链路状态数据库），本质就是图的邻接表。
2. **运行 Dijkstra 算法**：路由器基于 LSDB 运行 Dijkstra 算法，计算出从自身到达每一个目的网络的最短路径。
3. **生成路由表**：根据 Dijkstra 算法的运行结果，构造路由表，路由表结构为【目的网络，下一跳，到目的网络的距离】。
![[../../CN_Picture/Pasted image 20251229214237.png]]
##### **区域划分**：用于规模大的网络
- 将一个自治系统划分为若干区域
	- **洪泛法**交换链路状态信息局限在各个区域，减少网络通信量，使得 LSDB 减小
- 一个 OSPF 自治系统中，只有一个**主干区域**
	- **主干区域作用**：联通其他区域，**标识符**：Area ID=0
	- 主干区域内，至少有一台**自治系统路由器**（ASBR）与其他自治系统相连
	- 每一个非主干区域，至少有一台**区域边界路由器**（ABR）与主干区域相连
	- 非主干区域和主干区域通常直接相连
##### 几类路由器
![[../../CN_Picture/Pasted image 20251229222340.png]]
- **自治系统边界路由器**（R6）负责本自治系统与其他自治系统之间的IP分组路由转发
- **区域边界路由器**（R3、R4、R7）负责为流向/流出该区域的IP分组提供路由转发，需要知道**直连区域**与**主干区域**的网络拓扑
- **区域内部路由器**（R1、R2、R5、R8、R9）也称非边界路由器，负责本区域内的IP分组路由转发，仅需知道本区域的网络拓扑，发往其他区域的IP分组会转发给“区域边界路由器”处理
##### 术语注释
**LSA**：链路状态通告，OSPF 协议中定义的一种数据结构，LSDB 中的一条链路
**LSI**：链路状态信息，广义概念，指代所有描述链路状态的信息

#### 4.4.4.3 OSPF 分组类型
![[../../CN_Picture/Pasted image 20251229223040.png]]
- **Hello 分组**：各台路由器每隔 10 秒向直接邻居发送一次“**问候分组**”如果超过 40 秒未收到邻居的问候，就认为该邻居不可达
- **DD 分组**：两台路由器的邻居关系建立时，通过数据库描述分组，向邻居给出自己的 LSDB,摘要 (即 LSA 的头信息)；**若数据过多**，可拆分发送
- **LSR 分组**：通过 LSR 分组先邻居请求缺少的 LSA（头信息）
- **LSU 分组**：路由器通过 LSU 分组，向邻居传输具体的 LSA (可能引发全网洪泛)
- **LSAck 分组**：路由器收到邻居发来的 LSU 后，返回 LSAck 分组，向邻居确认收到了哪些 LSA (头信息)；**注**：即便重复收到洪泛的 LSU 分组，也要返回 LSAck
- 


### 4.4.5 BGP：边界网关协议
#### 4.4.5.1 BGP 特点与基本概念
BGP 是一种**外部网关协议**，用于在**自治系统**（AS）之间交换路由信息，实现**路由选择**。既要运行**内部网关协议**，又要运行 BGP 协议
1. BGP 力求找到一条自治系统之间比较好的路由，而不是“最佳”路由。  
2. AS 之间的路由选择必须考虑政治、安全或经济等有关因素。  
3. 采用**路径向量路由算法**——路由器之间通告 BGP 路由信息时，不仅告知目的地，还告知到达该目的地的完整路径（即需要经过哪些自治系统）。  
4. BGP 是**应用层**协议，基于 TCP（端口号 179）。
**BGP 邻居**：BGP 协议的通信双方称为 **BGP 对等方**（BGP peers），也常译为“BGP 邻居”。BGP 邻居之间**先建立 TCP 连接**，然后在该连接上交换 BGP 报文，从而建立 BGP 会话。
**BGP 会话两类**：  
- **eBGP 会话**：两个 AS 的直连边界路由器之间，长期保持 eBGP 会话。  
- **iBGP 会话**：AS 内部的 BGP 路由器之间，长期两两保持 iBGP 会话。  
  注意：规定 AS 内 iBGP 会话必须全连通（Full Mesh）。N 个路由器形成 N×(N−1)/2 条 iBGP 会话。
#### 4.4.5.2 BGP 路由信息与工作原理
#### 4.4.5.2 BGP 路由信息属性与工作原理
CIDR 前缀：指向目的网络。  
AS-PATH（自治系统路径）：描述到达目的网络需要经过哪些自治系统（用 ASN 序列表示）。  
NEXT-HOP（下一跳）：  
- 对 eBGP：默认不修改“下一跳”，值为 eBGP 发送方路由器自己的 IP
- 对 iBGP：也可修改为 iBGP 发送方路由器自己的 IP
BGP **关键规则**：iBGP 学到的路由不能再通过 iBGP 传播给其他 iBGP 邻居，避免环路传播。  
**注**：AS 内 iBGP 会话是全连通（Full Mesh）的，这样可以确保 AS 内所有路由器都能收到从外部学来的、一致的 BGP 路由信息。
##### 工作原理
![[../../CN_Picture/Pasted image 20251230003018.png]]
#### 4.4.5.3 BGP 路由选择
当外部AS到达同一目的网络X存在多条AS-PATH时，按以下顺序决策：
1. **选择本地偏好值最高的路由**  
   本地偏好值由本AS管理员设置，反映成本、安全等策略，值越大优先级越高。
2. **选择AS跳数最少的路由**  
   注意：AS跳数最少并不意味着路由器跳数最少。
3. **热土豆路由选择**   理念：烫手的土豆尽快脱手。
   若AS跳数相同，则让IP分组以“最小代价”离开本AS：  
   - 用内部网关协议（RIP/OSPF）计算本AS内到各出口的最短路径  
   - RIP以路由器跳数为代价，OSPF以路径总长度为代价  
4. **选择BGP标识符最小的路由**  
   若仍相同，则比较BGP邻居的32 bit BGP标识符（通常选路由器各接口中更大的IP地址作为标识符），选最小者。理念：两个员工都说得好，听“老员工”的（工号更小）。
#### 4.4.5.4 BGP 四种报文
1. **Open（打开）报文**  
   发送时机：TCP 连接成功后，BGP 发出的第一个报文。  
   作用：与相邻 BGP 对等方建立 BGP 会话，使通信初始化。
2. **Update（更新）报文**  
   发送时机：发现新的路由信息，或发现老的路由信息发生变化。  
   作用：通知某一路由的信息，并列出要撤销的多条路由。
3. **Keepalive（保活）报文**  
   发送时机：周期性发送（例如 60 秒一次）。  
   作用：通知 BGP 对等方“我还活着”。若超过 60×3＝180 秒未收到，则说明 BGP 会话出问题。
4. **Notification（通知）报文**  
   发送时机：检测到 BGP 错误时（例如 BGP 报文首部参数错误）。  
   作用：发送检测到的错误，并立即关闭 BGP 会话。
### [[第四章 网络层|回到目录]]