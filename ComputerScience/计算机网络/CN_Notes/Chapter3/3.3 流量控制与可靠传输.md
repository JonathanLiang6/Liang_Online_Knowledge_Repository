### 3.3.1 滑动窗口机制
#### 3.3.1.1 窗口概念介绍
$W_T$：发送窗口：发送方当前允许发送的帧
$W_R$：接收窗口：接收方当前允许接收的帧
收到接收窗口之外的帧会直接丢弃
#### 3.3.1.2 确认与否认机制  
- **确认帧 $ACK_i$**：接收方收到 i 号帧且无差错，返回 $ACK_i$。  
- **否认帧 NAK_i**：接收方检测到 i 号帧有差错，丢弃该帧并返回 NAK_i。  
#### 3.3.1.3 重传机制  
1. **超时重传**：发送方超时未收到 $ACK_i$，则重传 i 号帧。  
2. **请求重传**：发送方收到 NAK_i，则立即重传 i 号帧。  
#### 3.3.1.4 帧编号要求  
- 至少使用 n bit 给帧编号。  
- 窗口大小约束：$W_T + W_R \le 2^n$。
### 3.3.2 停止-等待协议（S-W）
#### 3.3.2.1 四大特点
##### 窗口特征  
- 发送窗口 $W_T = 1$，接收窗口 $W_R = 1$。  
- 每发送 1 帧即停止，等待对方确认后才继续发送下一帧。  
##### 确认机制  
- 接收方收到无差错帧后，返回确认帧 $ACK_i$。  
- 发送方收到 $ACK_i$ 后，滑动发送窗口，发送下一帧。  
##### 重传机制  
- 超时重传：发送方在超时计时器内未收到 $ACK_i$，重传该帧。   
##### 帧编号  
- 仅需 1 bit 编号（0/1 交替即可）。  
- 满足一般窗口约束：$W_T + W_R \le 2^n$，此处 $n=1$。  
#### 3.3.2.2 流量控制窗口滑动条件  
- 发送窗口滑动：收到对应帧的 ACK 后，向前滑动 1 位。  
- 接收窗口滑动：成功接收并按序交付帧后，向前滑动 1 位。  
#### 3.3.2.3 差错与异常情况  
| 场景       | 收发双方行为                                |
| -------- | ------------------------------------- |
| 数据帧丢失    | 接收方无任何响应，发送方超时后重传。                    |
| 数据帧出错被丢弃 | 接收方不返回 ACK，发送方超时后重传。                  |
| 收到重复帧    | 接收方再次返回上次已发送的 ACK，丢弃重复数据；发送方忽略重复 ACK。 |
- 停止-等待协议每次仅处理 1 帧，**不存在数据帧失序问题**。
### 3.3.3 后退 N 帧协议（GBN）
#### 3.3.3.1 四大特点
##### 窗口特征  
- 发送窗口 $W_T＞1$，接收窗口 $W_R = 1$。  
- 发送方可连续发出多帧，但接收方仅按序接收，一次只交付一帧。  
##### 确认机制  
- 接收方可“累积确认”：返回 $ACK_i$ 表示已正确收到 i 号帧及其之前所有帧。  
##### 重传机制  
- 超时重传：发送方超时未收到 $ACK_i$，则重传 i 号帧及其后所有已发帧。  
- 请求重传：收到“非法帧”时，接收方丢弃该帧，并回送最后一个正确帧的 ACK，迫使发送方“后退”到 i+1 号帧重新发送。  
##### 帧编号  
- 至少使用 n bit 编号，满足 $W_T + W_R \le 2^n$。   
#### 3.3.3.2 关于确认帧
接收方可以“累积确认”。即连续收到多个数据帧时，可以仅返回最后一个帧的 $ACK_i$，表示接收方已收到 i 号帧及其之前的所有帧。
#### 3.3.3.3 要点
- 关于超时重传：若发送方超时未收到 $ACK_i$，则重传 i 号帧，及其之后的所有帧。  
- 收到一个“非法帧”时，接收方会将此帧丢弃，并返回目前已接收的最后一个正确帧的 $ACK_i$，以提醒发送方“后退”回 i+1 号帧重新发送。  
  - 注：“非法帧”包括落在接收窗口之外的帧、检测出差错的帧。
- 缺点：如果接收方接收帧的速度很慢，或在信道误码率很高的情况下，可能会导致发送方的发送进度经常需要“后退”，传输效率低。
### 3.3.4 选择重传协议（SR）

#### 3.3.4.1 四大特点
##### 窗口特征  
- 发送窗口 $W_T > 1$，接收窗口 $W_R > 1$。  
- 发送方可连续发出多帧，接收方可无序接收并缓存，仅缺失帧到达后一次性按序交付。  
##### 确认机制  
- **不能**“累积确认”，必须“一帧一确认”：收到无差错帧 i 立即返回 $ACK_i$。  
- 若检测到帧差错，接收方丢弃该帧并返回 $NAK_i$，主动请求重传。  
##### 重传机制  
- 超时重传：发送方超时未收到 $ACK_i$，仅重传 i 号帧。  
- 请求重传：发送方收到 $NAK_i$，立即重传 i 号帧。  
##### 帧编号  
- 至少使用 n bit 编号，满足 $W_T + W_R \le 2^n$。  
#### 3.3.4.2 要点补充
- 接收方不能“累计确认”，必须对每个正确帧单独返回 $ACK_i$。  
- 检测到帧差错时，接收方丢弃错帧并回送 NAK_i，主动要求重传该帧。  
### 3.3.5 三种协议信道利用率分析
#### 3.3.5.1 基本符号定义  
- $T_D$：一个数据帧的传输时延（发送时延）。  
- $T_A$：一个 ACK 确认帧的传输时延（发送时延）。  
- $RTT$：往返时延，即两倍的单向传播时延。  
#### 3.3.5.2 停止-等待协议（S-W）  
- 发送窗口 $W_T = 1$，接收窗口 $W_R = 1$。  
- 周期长度：$T_D + RTT + T_A$。  
- 理想信道利用率：  $$
  U_{\text{S-W}} = \frac{T_D}{T_D + RTT + T_A}
  $$- 注意：很多题目会忽略确认帧的传输时延 $T_A$。  
#### 3.3.5.3 后退 N 帧协议（GBN）  
- 发送窗口 $W_T = N$，接收窗口 $W_R = 1$。  
- 周期长度：$T_D + RTT + T_A$（连续发送 N 帧后等待一次 ACK）。  
- 理想信道利用率：  $$
  U_{\text{GBN}} = \frac{N \cdot T_D}{T_D + RTT + T_A}
  $$约束：用 n bit 编号，需满足 $W_T + W_R \le 2^n$。  
#### 3.3.5.4 选择重传协议（SR）  
- 发送窗口 $W_T = N$，接收窗口 $W_R > 1$。  
- 周期长度与 GBN 相同：$T_D + RTT + T_A$。  
- 理想信道利用率：  $$
  U_{\text{SR}} = \frac{N \cdot T_D}{T_D + RTT + T_A}
  $$约束：同样用 n bit 编号，需满足 $W_T + W_R \le 2^n$。  
#### 3.3.5.5 比较与结论  
- 在相同 n bit 编号下，GBN 的 $W_R = 1$，SR 的 $W_R > 1$，因此 GBN 可允许更大的 $W_T$，从而获得更高的最大信道利用率。  
- 所有协议的理想信道利用率上限为 1，即 $U \le 1$。  
- 滑动窗口协议：泛指 GBN 或 SR 协议。  
- ARQ 协议：泛指 S-W、GBN、SR 协议。  
- 连续 ARQ 协议：泛指 GBN 或 SR 协议。
### [[../../CN_Contents/第三章 数据链路层|回到目录]]