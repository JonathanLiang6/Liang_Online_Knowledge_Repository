### 5.3.1 TCP 协议框架
[[5.2 UDP#5.2.1.2 UDPvsTCP|TCP报文段]]
#### 5.3.1.1 TCP 协议
![[../../CN_Picture/Pasted image 20251204000004.png]]
- **客户端**：主动发起连接的一方
- **服务器**：被动等待连接的一方
**协议阶段**：**建立连接**(3 次握手) $\Rightarrow$ **数据传输** $\Rightarrow$ **释放连接**（4 次挥手）
#### 5.3.1.2 TCP 协议解释
- 建立一次 TCP 连接可以传输多个报文（双向均可）
- TCP 面向**字节流**，无论传输多少报文，在 TCP 协议看来只是字节流
### 5.3.2 TCP 报文段
![[../../CN_Picture/Pasted image 20251204161355.png]]
### 5.3.3 TCP 连接管理
#### 5.3.3.1 建立连接-三次握手
- **TCP段相关问题**
	- 握手①②不能携带数据（只有 TCP 首部），但是仍要消耗一个序号
	- 握手②的 ack=握手①的 seq +1
	- 握手①②的起始序号由客户端/服务器进程自己决定 
	- 握手③如果不携带数据就不消耗序号 $\Leftrightarrow$ 携带多少 B 的数据消耗多少序号
- **TCP状态转换**：
![[../../CN_Picture/Pasted image 20251204201830.png]]
- **耗时分析**：established 阶段就可以发送数据
	- 发出握手① $\Rightarrow$ **客户端**进程可以发送数据：耗时至少 1RTT
	- 发出握手① $\Rightarrow$ **服务器**进程可以发送数据：耗时至少 1.5RTT
#### 5.3.3.2 释放连接-四次挥手
- **TCP段相关问题**：
	- 挥手①③即使不携带数据，也要消耗一个序号
		- 大多情况下不携带数据（可以携带）
	- 挥手②可以携带数据 $\Leftrightarrow$ 挥手④不可以携带数据
- **TCP状态转换**：![[../../CN_Picture/Pasted image 20251204202647.png]]
	- **注**：服务器也可以发出挥手
	- **补充**：
		1. 客户进程收到挥手③后进入时间等待状态，启动 TIME-WAIT 计时器，倒计时 $2\times MSL$ 后进入 close 状态（若在此阶段间重复收到了挥手③，则需要重置计时器）
		2. **MSL**：最长报文段寿命，是由 TCP 协议规定的一个固定**时间**长度
- **耗时分析**
	- 从**客户**发出挥手①，到**客户**进入 close，至少需要 1RTT+2MSL
	- 从**客户**发出挥手①，到**服务器**进入 close，至少需要 1.5RTT
	- **补充**：如果服务器收到挥手①时没有待传送数据，那么可以连续发出挥手②③
### 5.3.4 TCP 可靠传输与流量控制
#### 5.3.4.1 可靠传输机制
- **序号**：进程在建立连接时确定起始序号，数据传输过程中，每个字节对应一个序号。
##### 确认机制
- **累积确认规则**：收到 ack_seq=n，说明序号在 n 之前的所有字节都已正确接收。
![[../../CN_Picture/Pasted image 20251208221123.png]]
![[../../CN_Picture/Pasted image 20251208221148.png]]**返回 ACK 的时机-推迟确认**  
- 推迟时间最多不能超过 0.5 秒（TCP 标准规定）。  
- 如果自己也有数据要传送给对方，立即返回 ACK 段，并“捎带”自己的数据。  
- 若连续收到两个长度为 MSS 的报文段，就应该立即返回 ACK 段。
**两种 ACK 段**  
- 专门确认（咸鱼不规范术语）：一个 ACK 段只有 TCP 首部，而没有携带数据。  
- 捎带确认：一个 ACK 段顺道携带了数据，就是“捎带确认”。
##### 重传机制  
![[../../CN_Picture/Pasted image 20251208221419.png]]
1. **超时重传**  
   - 每发出一个报文段，就设置一个计时器。若计时器到期还没收到确认，就重传这一报文段，并重置计时器。  
2. **快重传**  
   - **作用**：让可能出错的报文段尽早重传，而不是非要等到超时再重传。
   - **配套机制**：立即确认
	   - 每收到一个 TCP 报文段，就立即返回一个 ACK 段（立即确认）。  
	   - 即使收到一个失序报文段，也要立即返回 ACK 段（失序报文段会导致冗余 ACK）。  
   - 当发送方连续收到**1+3个确认号相同**的冗余 ACK 时，就立即重传该确认号对应的报文段。
### 5.3.5 TCP 拥塞控制
#### 5.3.5.0 TCP 拥塞控制与流量控制的区别与联系
**流量控制**：控制端到端的数据发送量，是“局部的”  
**拥塞控制**：控制整个网络中每台主机的数据发送量，降低路由器负载，是“全局的”  
如何判断网络拥塞？  如果检测到网络拥塞怎么办？  
- 发出的每个报文段，都能顺利地收到 ACK 确认 → 不拥塞  
	- 迅速减少发送的数据量 $\Rightarrow$ **拥塞避免算法**
- 发出的报文段未能按时收到 ACK，引发超时重传 → 严重拥塞  
	- 严重拥塞就迅速缩小拥塞窗口 $\Rightarrow$ **慢开始算法**
- 收到 3 个重复 ACK，引发快重传 → 有点拥塞  
	- 有点拥塞就适当缩小拥塞窗口 $\Rightarrow$ **快恢复算法**
**发送窗口**的上限值=min (rwnd 接收窗口, cwnd 拥塞窗口)
#### 5.3.5.1 慢开始算法 
![[../../CN_Picture/Pasted image 20251209004805.png]]
![[../../CN_Picture/Pasted image 20251209004838.png]]
![[../../CN_Picture/Pasted image 20251209005307.png]]
![[../../CN_Picture/Pasted image 20251209005352.png]]
#### 5.3.5.2 拥塞避免算法
#### 5.3.5.3 快恢复算法
发生**快重传机制**后，触发快恢复算法
![[../../CN_Picture/Pasted image 20251208222014.png]]
0-4：慢开始     4-12：拥塞避免
ssthresh=cwnd/2，但应该≥2
![[../../CN_Picture/Pasted image 20251208235008.png]]
上图为详细过程
### [[../../CN_Contents/第五章 传输层|回到目录]]